<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.28.xsd">

    <changeSet id="001-create-dashboard-history-table" author="system">
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <not>
                <tableExists tableName="dashboard_history"/>
            </not>
        </preConditions>
        <comment>创建仪表板生成历史记录表</comment>
        <createTable tableName="dashboard_history">
            <column name="id" type="VARCHAR(64)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="user_id" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="config_json" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="generated_html" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="preview_image" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="true"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <setTableRemarks tableName="dashboard_history" remarks="仪表板生成历史记录"/>
        <setColumnRemarks tableName="dashboard_history" columnName="id" remarks="记录ID"/>
        <setColumnRemarks tableName="dashboard_history" columnName="user_id" remarks="用户ID"/>
        <setColumnRemarks tableName="dashboard_history" columnName="config_json" remarks="仪表板配置JSON"/>
        <setColumnRemarks tableName="dashboard_history" columnName="generated_html" remarks="生成的HTML代码"/>
        <setColumnRemarks tableName="dashboard_history" columnName="preview_image" remarks="Base64预览图片"/>
    </changeSet>

    <changeSet id="002-create-dashboard-templates-table" author="system">
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <not>
                <tableExists tableName="dashboard_templates"/>
            </not>
        </preConditions>
        <comment>创建仪表板模板配置表</comment>
        <createTable tableName="dashboard_templates">
            <column name="type" type="VARCHAR(32)">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="data_json" type="JSONB">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="VARCHAR(16)" defaultValue="1.0">
                <constraints nullable="true"/>
            </column>
            <column name="enabled" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="true"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="true"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <setTableRemarks tableName="dashboard_templates" remarks="仪表板模板配置"/>
        <setColumnRemarks tableName="dashboard_templates" columnName="type" remarks="模板类型(purposes/layouts/themes/components)"/>
        <setColumnRemarks tableName="dashboard_templates" columnName="data_json" remarks="模板数据JSON"/>
        <setColumnRemarks tableName="dashboard_templates" columnName="version" remarks="模板版本"/>
        <setColumnRemarks tableName="dashboard_templates" columnName="enabled" remarks="是否启用"/>
    </changeSet>

    <changeSet id="003-create-dashboard-indexes" author="system">
        <comment>创建仪表板相关索引</comment>
        <!-- dashboard_history 索引 -->
        <createIndex tableName="dashboard_history" indexName="idx_dashboard_history_user_created">
            <column name="user_id"/>
            <column name="created_at" descending="true"/>
        </createIndex>
        
        <createIndex tableName="dashboard_history" indexName="idx_dashboard_history_created">
            <column name="created_at" descending="true"/>
        </createIndex>
        
        <!-- JSONB字段的GIN索引，使用原生SQL -->
        <sql dbms="postgresql">
            CREATE INDEX IF NOT EXISTS idx_dashboard_history_config_gin 
            ON dashboard_history USING GIN (config_json);
        </sql>
        
        <!-- dashboard_templates 索引 -->
        <createIndex tableName="dashboard_templates" indexName="idx_dashboard_templates_type_enabled">
            <column name="type"/>
            <column name="enabled"/>
        </createIndex>
        
        <sql dbms="postgresql">
            CREATE INDEX IF NOT EXISTS idx_dashboard_templates_data_gin 
            ON dashboard_templates USING GIN (data_json);
        </sql>
    </changeSet>

    <changeSet id="004-add-dashboard-constraints" author="system">
        <comment>兼容旧版本变更集ID，历史上该ID包含约束添加；现已拆分为 004a-004d。本变更集不执行任何DDL，仅用于兼容以避免旧ID导致的执行错误。</comment>
        <sql dbms="postgresql">
            SELECT 1;
        </sql>
    </changeSet>

    <changeSet id="004a-add-chk-id-format" author="system">
        <comment>dashboard_history: 校验 id 格式</comment>
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <sqlCheck expectedResult="0">
                SELECT COUNT(1)
                FROM pg_constraint c
                JOIN pg_class t ON t.oid = c.conrelid
                WHERE c.conname = 'chk_id_format' AND t.relname = 'dashboard_history'
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">
            ALTER TABLE dashboard_history
            ADD CONSTRAINT chk_id_format
            CHECK (id ~ '^[a-zA-Z0-9_-]{1,64}$');
        </sql>
    </changeSet>

    <changeSet id="004b-add-chk-config-json-not-empty" author="system">
        <comment>dashboard_history: JSON 非空校验</comment>
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <sqlCheck expectedResult="0">
                SELECT COUNT(1)
                FROM pg_constraint c
                JOIN pg_class t ON t.oid = c.conrelid
                WHERE c.conname = 'chk_config_json_not_empty' AND t.relname = 'dashboard_history'
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">
            ALTER TABLE dashboard_history
            ADD CONSTRAINT chk_config_json_not_empty
            CHECK (
                config_json IS NOT NULL
                AND jsonb_typeof(config_json) IN ('object','array')
                AND config_json <> '{}'::jsonb
            );
        </sql>
    </changeSet>

    <changeSet id="004c-add-uk-type-version" author="system">
        <comment>dashboard_templates: 添加唯一约束</comment>
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <sqlCheck expectedResult="0">
                SELECT COUNT(1)
                FROM pg_constraint c
                JOIN pg_class t ON t.oid = c.conrelid
                WHERE c.conname = 'uk_type_version' AND t.relname = 'dashboard_templates'
            </sqlCheck>
        </preConditions>
        <addUniqueConstraint tableName="dashboard_templates" columnNames="type,version" constraintName="uk_type_version"/>
    </changeSet>

    <changeSet id="004d-add-chk-valid-json" author="system">
        <comment>dashboard_templates: JSON 结构校验</comment>
        <preConditions onFail="MARK_RAN" onError="CONTINUE">
            <sqlCheck expectedResult="0">
                SELECT COUNT(1)
                FROM pg_constraint c
                JOIN pg_class t ON t.oid = c.conrelid
                WHERE c.conname = 'chk_valid_json' AND t.relname = 'dashboard_templates'
            </sqlCheck>
        </preConditions>
        <sql dbms="postgresql">
            ALTER TABLE dashboard_templates
            ADD CONSTRAINT chk_valid_json
            CHECK (jsonb_typeof(data_json) = 'array' OR jsonb_typeof(data_json) = 'object');
        </sql>
    </changeSet>

</databaseChangeLog>